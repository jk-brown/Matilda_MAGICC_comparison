---
title: "Emulating MAGICC"
author: "Joe Brown"
date: "2025-01-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
source("utils/source_all.R")
```

# Goal

Use MAGICC data to run an analysis where Hector + Matilda "emulates" MAGICC. 

To do this:

1. Create a "MAGICC" criterion using the MAGICC warming data from Ou and Iyer. 

2. Use the criterion to weight the Hector ensemble from Matilda.

3. Plot full weighted ensemble -- median and uncertainty range. 

4. Plot constrained ensemble -- selecting the top X number of Hector runs based on weight.

5. Compare parameters of Hector vs. MAGICC emulated Hector.

To start, load `model_result.RDS` from the `data/output` directory.

# New Scoring Criterion using MAGICC

Create new MAGICC criterion:
```{r}
# load magicc data
magicc_data <- read.csv("data/raw-data/ou_Iyer_global_mean_temperature.csv")
magicc_data_bau <- magicc_data %>%
  subset(scenario == "T_01_BAU") %>% 
  select(-scenario)
  
# create new criterion
criterion_magicc <- new_criterion("global_tas", years = magicc_data_bau$year, obs_values = magicc_data_bau$value)
```

Score model results using magicc data:
```{r}
bau_data <- model_result$T_01_BAU

# calculating bounds for score_ramp
uncertainty <- magicc_unc %>% 
  mutate(
    w1 = (upper - lower) / 4,
    w2 = (upper - lower) / 2
  )


model_scores_magicc <- score_runs(bau_data, criterion = criterion_magicc, score_function = score_ramp, w1 = 0.2, w2 = 2.0)

```

Filter the top 600 weights:
```{r}
top_percentile <- quantile(model_scores_magicc$weights, 0.10)
top_scores_magicc <- model_scores_magicc %>%
  filter(weights >= top_percentile)

```

merge model weights with model results (for plotting later):
```{r}

weighted_ensemble_magicc <- merge(bau_data, top_scores_magicc, by = "run_number")

```

### Computing summary stats
```{r}
## subset to only include the variable of interest
gsat_data_weighted_magicc <- subset(weighted_ensemble_magicc, variable == "global_tas")

## normalize gsat data 
gsat_data_normalized_magicc <- normalize_to_reference(gsat_data_weighted_magicc, reference_start = 1850, reference_end = 1900)

## compute summary statistics
summary_weighting_magicc <-  gsat_data_normalized_magicc %>%
  group_by(year) %>%
  summarise(
    median = quantile(normalized_value, probs = 0.50),
    ci_05 = quantile(normalized_value, probs = 0.05),
    ci_10 = quantile(normalized_value, probs = 0.10),
    ci_33 = quantile(normalized_value, probs = 0.33),
    ci_67 = quantile(normalized_value, probs = 0.67),
    ci_90 = quantile(normalized_value, probs = 0.90),
    ci_95 = quantile(normalized_value, probs = 0.95),
    .groups = "drop"
  ) %>% 
  subset(year > 1994)

```

## plotting the weighted results 
```{r}
magicc_emulated_plot_weighted <- ggplot() +
  
  # Ribbon for 10th-90th percentile
  geom_ribbon(data = summary_weighting_magicc,
              aes(x = year,
                  ymin = ci_10,
                  ymax = ci_90),
              fill = "grey", alpha = 0.5) +

  # Ribbon for 33rd-67th percentile
  geom_ribbon(data = summary_weighting_magicc,
              aes(x = year,
                  ymin = ci_33,
                  ymax = ci_67),
              fill = 'orange', alpha = 0.5) +
  
  # Median line
  geom_line(data = summary_weighting_magicc, 
            aes(x = year, y = median, color = "Hector (MAGICC Emulated) Median"), 
            linewidth = 0.7) +
  
  # Ou and Iyer et al. 2021 line
  geom_line(data = subset(ou_data, scenario == "T_01_BAU"), 
            aes(x = year, y = value, color = "Ou and Iyer et al. 2021"), 
            linewidth = 0.7) +
  
  geom_ribbon(data = magicc_unc,
              aes(x = year, ymin = lower, ymax = upper),
              color = "red", linetype = "dashed", fill = NA, alpha = 0.2) +
  
  # Add labels and theme
  labs(
    title = "Constrained/Weighted Projections -- MAGICC Emulation",
    x = "Year",
    y = "Temperature Anomaly (°C)",
    color = "Legend"
  ) +
  
  # Add custom colors for the legend
  scale_color_manual(
    values = c(
      "Hector (MAGICC Emulated) Median" = "black",
      "Ou and Iyer et al. 2021" = "red"
    )
  ) +
  
  theme_light() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    strip.text = element_text(size = 12), # Facet label size
    legend.position = c(0.2, 0.8), # Manually position the legend
    legend.justification = "center"
  )

magicc_emulated_plot_weighted

# ggsave("figures/magicc_emulation_wide_ecs_exp_BAU.png",
#        magicc_emulated_plot_weighted,
#        device = "png",
#        height = 7,
#        width = 10,
#        units = "in",
#        dpi = 300)
```

## Magic emulated figure

Figure showing the entire weighted/constrained ensemble:
```{r}
magicc_emulated_weighted_ensemble_bau <- 
  ggplot() +
  geom_line(
    data = subset(gsat_data$T_01_BAU, year > 1849),
    aes(
      x = year,
      y = normalized_value,
      group = run_number,
      color = "Hector Ensemble (5000 member)"
    ),
    alpha = 0.4,
    linewidth = 0.1
  ) +
  geom_line(
    data = subset(gsat_data_normalized_magicc, year > 1849),
    aes(
      x = year,
      y = normalized_value,
      group = run_number,
      color = "Constrained Ensemble (4500 member)", 
      alpha = weights
    ),
    linewidth = 0.1
  ) +
  scale_alpha_continuous(range(c(0.8, 1))) + # how extreme should the transparency gradient be - this is optional
  guides(alpha = "none") + # remove alpha legend 
  # Add labels and theme
  labs(
    title = "4500-member Constrained Hector Ensemble (BAU)",
    x = "Year",
    y = "Temperature Anomaly (°C)",
    color = "Legend"
  ) +
  
  geom_line(data = obs_temp, aes(x = year, y = value, color = "Historic Temperature (one SD)")) +
  geom_ribbon(data = obs_temp_sd, aes(x = year, ymin = value - sd, ymax = value + sd), alpha = 0.3, fill = "navy") +
  
  # Add custom colors for the legend
  scale_color_manual(
    values = c(
      "Hector Ensemble (5000 member)" = "grey",
      "Constrained Ensemble (4500 member)" = "#31A354",
      "Historic Temperature (one SD)" = "navy"
    )
  ) +
  theme_light() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 8),
    legend.position = c(0.01, 0.99),  # Use this to place the legend inside the panel
    legend.justification = c(0, 1), # Align legend's top-left corner
    legend.background = element_rect(fill = "white", color = "black")
  )

magicc_emulated_weighted_ensemble_bau

 ggsave("figures/constrained_magicc_emulated_ensemble_bau.png",
        magicc_emulated_weighted_ensemble_bau,
        device = "png",
        height = 7,
        width = 10,
        units = "in",
        dpi = 300)
```

Figure showing the entire weighted/constrained ensemble -- with median and range:
```{r}
full_magicc_emulated_ensemble_constrained <- 
  ggplot() +
  geom_line(
    data = subset(gsat_data$T_01_BAU, year > 1849),
    aes(
      x = year,
      y = normalized_value,
      group = run_number,
      color = "Hector Ensemble (5000 member)"
    ),
    alpha = 0.4,
    linewidth = 0.1
  ) +
  geom_line(
    data = subset(gsat_data_normalized_magicc, year > 1849),
    aes(
      x = year,
      y = normalized_value,
      group = run_number,
      color = "Constrained Ensemble (4500 member)", 
      alpha = weights
    ),
    linewidth = 0.1
  ) +
  scale_alpha_continuous(range(c(0.8, 1))) + # how extreme should the transparency gradient be - this is optional
  guides(alpha = "none") + # remove alpha legend 
  # Add labels and theme
  labs(
    title = "4500-member Constrained Hector Ensemble (BAU)",
    x = "Year",
    y = "Temperature Anomaly (°C)",
    color = "Legend"
  ) +
  
  geom_line(data = obs_temp, aes(x = year, y = value, color = "Historic Temperature (one SD)")) +
  geom_ribbon(data = obs_temp_sd, aes(x = year, ymin = value - sd, ymax = value + sd), alpha = 0.3, fill = "navy") +
  
  # Adding the median and CI projection
  geom_ribbon(data = summary_weighting_magicc, 
              aes(x = year, ymin = ci_05, ymax = ci_95), 
              fill = "red", alpha = 0.2) +
  geom_ribbon(data = summary_weighting_magicc, 
              aes(x = year, ymin = ci_10, ymax = ci_90), 
              fill = "red", alpha = 0.3) +
  geom_ribbon(data = summary_weighting_magicc, 
              aes(x = year, ymin = ci_33, ymax = ci_67), 
              fill = 'red', alpha = 0.5) +
  
  # Median line
  geom_line(data = summary_weighting_magicc, 
            aes(x = year, y = median, color = "Hector Median"), 
            linewidth = 0.7) +
  
  # add magic range
  geom_ribbon(data = magicc_unc, 
              aes(x = year, ymin = lower, ymax = upper, color = "MAGICC Range"), fill = NA, linetype = "dashed", linewidth = 0.7) +
  
  # Add custom colors for the legend
  scale_color_manual(
    values = c(
      "Hector Ensemble (5000 member)" = "grey",
      "Constrained Ensemble (4500 member)" = "#31A354",
      "Historic Temperature (one SD)" = "navy", 
      "Hector Median" = "darkred", 
      "MAGICC Range" = "dodgerblue4"
    )
  ) +
  theme_light() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 8),
    legend.position = c(0.01, 0.99),  # Use this to place the legend inside the panel
    legend.justification = c(0, 1), # Align legend's top-left corner
    legend.background = element_rect(fill = "white", color = "black")
  )

full_magicc_emulated_ensemble_constrained

ggsave("figures/full_magicc_emulated_ensemble_constrained.png",
       full_magicc_emulated_ensemble_constrained,
       device = "png",
       height = 7,
       width = 10,
       units = "in",
       dpi = 300)
```

## computing probabilisties

```{r}
# define metric
warming_metric <- new_metric(var = "global_tas", years = 2100, op = median)

# computing metrics 
metric_result_emulated <- metric_calc(gsat_data_normalized_magicc, warming_metric)

# merge metrics with top_scores
top_magicc_emulated_metrics <- merge(metric_result_emulated, top_scores_magicc, by = "run_number")

# define temperature ranges of interest -- align with ou and Iyer 
temp_ranges <- c(1, 1.5, 2, 3, 4, Inf)

# run prob_calc
prob_results <- prob_calc(top_magicc_emulated_metrics$metric_result,
                          bins = temp_ranges,
                          scores = top_magicc_emulated_metrics$weights)
```


Plotting probability
```{r}
temp_cols <- c("lightgrey","salmon", "#B2182B","#67001F")

# order levels
prob_results$scenario <- "T_01_BAU"

probability_plot <- 
  ggplot(data = prob_results, # identify the data location
         aes(
           fill = bins, # how fill should be applied
           x = scenario, # what data goes on the x-axis
           y = probability)) + # what data goes on the y-axis
  # below we will be flipping the coord of the figure so right now the axes seem 
  # backwards from what we want.
  geom_bar(position = position_fill(reverse = T), # what type of plot we want and reverse the 
                                                  # stack order so cooler temps are on left
           stat = "identity", # we want the width of the bar pieces to be constrained by a value in the data
           width = 0.6) + # how wide do you want the bar - personal preference
  scale_y_continuous(breaks = seq(0.0, 1.0, 0.1)) + # set the number and interval of probability breaks
  scale_fill_manual(
    values = temp_cols, # indicate the color palette to use
    labels = c(         # edit labels for the legend
      expression(paste("1.5 to 2.0", ~degree, "C")),
      expression(paste("2.0 to 3.0", ~degree, "C")),
      expression(paste("3.0 to 4.0", ~degree, "C")),
      expression(paste(" > 4.0", ~degree, "C"))),
    name = "Warming") + # name of the legend
  labs(y = "Probability",
       x = "Scenario", 
       title = "Probability of Warming") +
  coord_flip() + # flip the coordinates of the figure to make horizontal representation
  theme_light() + # set theme - personal preference 
  theme(legend.position = "bottom") # change legend position - personal preference

probability_plot

ggsave("figures/constrained_probability_plot.png", 
       probability_plot,
       device = "png",
       dpi = 300, 
       height = 4)
```




## NEED TO RUN THE ABOVE ANALYSIS ACROSS ALL SCENARIOS BEFORE RUNNING THIS PLOT
```{r}
weighting_plot_df_emulated <- summary_weighting_magicc %>% 
  filter(!scenario %in% c("T_06_NDC_cont", "T_07_NDC_inc_LTS"))

# load ou and Iyer data
ou_data <- read.csv("data/raw-data/ou_Iyer_global_mean_temperature.csv")

parametric_uncertainty_plot_weighted <- ggplot() +
  # Ribbon for 10th-90th percentile
  geom_ribbon(data = weighting_plot_df, 
              aes(x = year, 
                  ymin = ci_10, 
                  ymax = ci_90), 
              fill = "grey", alpha = 0.5) +
  
  # Ribbon for 33rd-67th percentile
  geom_ribbon(data = weighting_plot_df, 
              aes(x = year, 
                  ymin = ci_33, 
                  ymax = ci_67), 
              fill = 'orange', alpha = 0.5) +
  
  # Median line
  geom_line(data = weighting_plot_df, 
            aes(x = year, y = median, color = "Hector Median"), 
            linewidth = 0.7) +
  
  # Ou and Iyer et al. 2021 line
  geom_line(data = ou_data, 
            aes(x = year, y = value, color = "Ou and Iyer et al. 2021"), 
            linewidth = 0.7) +
  
  # Facet by scenario
  facet_wrap(~scenario) +
  
  # Add labels and theme
  labs(
    title = "Constrained/Weighted Projections",
    x = "Year",
    y = "Temperature Anomaly (°C)",
    color = "Legend"
  ) +
  
  # Add custom colors for the legend
  scale_color_manual(
    values = c(
      "Hector Median" = "black",
      "Ou and Iyer et al. 2021" = "red"
    )
  ) +
  
  theme_light() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    strip.text = element_text(size = 12), # Facet label size
    legend.position.inside = c(0.82, 0.2), # Manually position the legend
    legend.justification = "center"
  )

parametric_uncertainty_plot_weighted


ggsave("emissions_projections_weighted.png", 
       device = "png",
       height = 7, 
       width = 10, 
       units = "in",
       dpi = 300)
```

